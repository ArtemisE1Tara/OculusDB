<!DOCTYPE html>
<html>
    <head>
        {meta}
        <link rel="stylesheet" href="/style.css" >
        <title>Information - OculusDB</title>
        <meta property="og:title" content="Information - OculusDB">
        <meta property="og:description" content="Shows information about an version, app or dlc">
    </head>
    <body>
        <div class="content">
            <h2>OculusDB Info</h2>
            <a href="/api/id/{0}">Raw Json</a>
            <table>
                <tr><td class="label">OculusDB Type</td><td id="type">Fetching...</td></tr>
                <tr><td class="label">Last Updated</td><td id="lastUpdated">Fetching...</td></tr>
            </table>
            <div>
                <h2>This</h2>
                <div id="this"><div class="loader"></div></div>
            </div>

            <div class="tabContainer">
                <h2>Connected</h2>
                <div class="tab">
                    <button class="tablinks active" onclick="openTab(event, 'applications')">Applications</button>
                    <button class="tablinks" onclick="openTab(event, 'dlcs')">DLCs</button>
                    <button class="tablinks" onclick="openTab(event, 'dlcpacks')">DLC Packs</button>
                    <button class="tablinks" onclick="openTab(event, 'versions')">Versions</button>
                </div>
                <div id="applications" style="display: block;" class="tabcontent active">
                    <div class="loader"></div>
                </div>
                <div id="dlcs" class="tabcontent">
                    <div class="loader"></div>
                </div>
                <div id="dlcpacks" class="tabcontent">
                    <div class="loader"></div>
                </div>
                <div id="versions" class="tabcontent">
                    <div class="loader"></div>
                </div>
                <input type="checkbox">
            </div>
            <div>
                <h2>Price history</h2>
                <div id="history">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
        <script src="/script.js"></script>
        <script>
            const id = "{0}"
            const applications = document.getElementById("applications")
            const dlcpacks = document.getElementById("dlcpacks")
            const dlcs = document.getElementById("dlcs")
            const versions = document.getElementById("versions")

            var object = {}
            var connected = {}

            //AddConnected();

            GetObjectById(id).then(res => {
                object = res
                AddConnected()
                document.getElementById("type").innerHTML = object.__OculusDBType
                document.getElementById("lastUpdated").innerHTML = new Date(object.__lastUpdated).toLocaleString()
            }).catch(err => {
                if(err == 404) {
                    alert("The item has not been found")
                } else if(err == 500) {
                    alert("Internal Server error")
                } else {
                    alet("An unknown error occurred")
                }
            })

            const priceHistory = document.getElementById("history")

            function PlotPrice() {
                fetch(`/api/pricehistory/${id}`).then(res => res.json().then(res => {
                    var x = []
                    var y = []
                    res.forEach(p => {
                        x.unshift(p.__lastUpdated)
                        y.unshift(p.newPriceFormatted ?? p.priceFormatted)
                    })
                    priceHistory.innerHTML = ""
                    Plotly.newPlot(priceHistory, [{
                        x: x,
                        y: y,
                        line: {
                            shape: "hv",
                            color: "#63FAC3"
                        }
                    }], {
                        width: "100%",
                        height: "100%",
                        font: {
                            color: "#EEEEEE"
                        },
                        plot_bgcolor: "#181A1B",
                        paper_bgcolor: "#181A1B"
                    })
                }))
            }

            function AddConnected() {
                fetch(`/api/connected/${id}`).then(res => res.json().then(res => {
                    connected = res
                    document.getElementById("this").innerHTML = AutoFormat(object, connected, "this_" + object.id)
                    RevealDescription("this_" + object.id)
                    if(object.__OculusDBType != "Version"){
                        var script = document.createElement("script")
                        script.src = "https://cdn.plot.ly/plotly-2.9.0.min.js"
                        script.onload = () => PlotPrice()
                        document.head.appendChild(script)
                    } else {
                        priceHistory.innerHTML = "Prices are not available for Versions"
                    }
                    var apps = ""
                    connected.applications.forEach(a => {
                        apps += FormatApplication(a, a.id)
                    })
                    if(!apps) apps = noResult
                    applications.innerHTML = apps

                    UpdateVersions(false)

                    var ds = ""
                    connected.dlcs.forEach(d => {
                        ds += FormatDLC(d, d.id)
                    })
                    if(!ds) ds = noResult
                    dlcs.innerHTML = ds

                    var dps = ""
                    connected.dlcPacks.forEach(dp => {
                        dps += FormatDLCPack(dp, connected.dlcs, dp.id)
                    })
                    if(!dps) dps = noResult
                    dlcpacks.innerHTML = dps
                }))
            }

            function UpdateVersions(showAll) {
                var vers = `<label class="checkmarkContainer">Show all versions<input type='checkbox' onclick='UpdateVersions(${!showAll})'${showAll ? " checked" : ""}><span class="checkmark"></span></label>`
                connected.versions.forEach(v => {
                    if(v.binary_release_channels.nodes.length > 0 || showAll)
                        vers += FormatVersion(v, v.id)
                })
                versions.innerHTML = vers
            }
        </script>
    </body>
</html>